<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Know My Rep - Find Your Representatives</title>
    <style>
        /* Your existing CSS styles remain unchanged */
    </style>
</head>
<body>
    <div class="kmr-container">
        <div class="kmr-hero">
            <h1>Know My Rep</h1>
            <p>Find ALL Your Elected Representatives - Local to Federal</p>
        </div>

        <div class="kmr-search-box">
            <div class="kmr-input-group">
                <input type="text" 
                       id="addressInput" 
                       class="kmr-input" 
                       placeholder="Enter your full address (e.g., 123 Main St, Baltimore, MD 21201)"
                       value="">
            </div>
            <div>
                <button onclick="findRepresentatives()" class="kmr-btn kmr-btn-primary">
                    Find My Representatives
                </button>
            </div>
            <div id="statusMessage"></div>
        </div>

        <div id="loadingDiv" class="kmr-loading" style="display: none;">
            <div class="kmr-spinner"></div>
            <p>Finding your representatives...</p>
        </div>

        <div id="resultsDiv"></div>
    </div>

    <script>
        // ============================================
        // CICERO API KEY CONFIGURATION
        // ============================================
        const CICERO_API_KEY = 'ccc7f60c9d8d5ccc0f7c849e754f5aef78ff706c';
        
        // CORS proxy services to bypass browser restrictions
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
            'https://cors.bridged.cc/',
            'https://cors-anywhere.herokuapp.com/'
        ];

        let currentProxyIndex = 0;

        async function findRepresentatives() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showStatus('Please enter your address', 'error');
                return;
            }

            // Check if API key is valid format
            if (!CICERO_API_KEY || CICERO_API_KEY.length < 30) {
                showStatus('Error: Invalid Cicero API key configuration.', 'error');
                console.error('Cicero API key appears to be invalid');
                return;
            }

            const loadingDiv = document.getElementById('loadingDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            showStatus('Searching for your representatives...', 'info');

            try {
                // Step 1: Geocode the address using OpenStreetMap (free, no CORS issues)
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=us&limit=1`;
                
                const geoResponse = await fetch(geocodeUrl);
                const geoData = await geoResponse.json();

                if (geoData && geoData.length > 0) {
                    const lat = geoData[0].lat;
                    const lon = geoData[0].lon;
                    const displayName = geoData[0].display_name;
                    
                    console.log('Geocoded address:', displayName);
                    showStatus(`Found location: ${displayName}`, 'success');
                    
                    // Step 2: Query Cicero API with the coordinates
                    await fetchCiceroOfficials(lat, lon, address);
                    
                } else {
                    throw new Error('Could not find that address. Please check the address and try again.');
                }
                
            } catch (error) {
                console.error('Error:', error);
                loadingDiv.style.display = 'none';
                showError(error.message || 'Could not fetch representatives. Please try again later.');
            }
        }

        async function fetchCiceroOfficials(lat, lon, address) {
            // Cicero API endpoint - using 'includechildren=1' to get ALL levels of officials
            const ciceroUrl = `https://cicero.azavea.com/v3.1/official?lat=${lat}&lon=${lon}&format=json&key=${CICERO_API_KEY}&includechildren=1&order=asc`;
            
            console.log('Fetching ALL elected officials from Cicero API...');
            let success = false;
            let lastError = null;

            // Try each CORS proxy until one works
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxy = CORS_PROXIES[currentProxyIndex];
                const proxyUrl = proxy + encodeURIComponent(ciceroUrl);
                
                try {
                    console.log(`Trying proxy: ${proxy}`);
                    
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                    });

                    const text = await response.text();
                    let data;
                    
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        console.error('Failed to parse response:', text);
                        throw new Error('Invalid response from API');
                    }

                    if (data.response && data.response.results) {
                        displayCiceroResults(data, address);
                        success = true;
                        break;
                    } else if (data.error) {
                        throw new Error(data.error.message || 'API error occurred');
                    }
                    
                } catch (error) {
                    lastError = error;
                    console.log(`Proxy ${currentProxyIndex} failed:`, error.message);
                    currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
                }
            }

            if (!success) {
                console.error('All CORS proxies failed');
                document.getElementById('loadingDiv').style.display = 'none';
                showError('Could not connect to Cicero API. Please try again later.');
            }
        }

        function displayCiceroResults(data, address) {
            const loadingDiv = document.getElementById('loadingDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            
            loadingDiv.style.display = 'none';
            
            try {
                const officials = data.response.results.officials || [];
                
                if (officials.length > 0) {
                    console.log('Total officials found:', officials.length);
                    
                    // Group officials by level
                    const grouped = groupOfficialsByLevel(officials);
                    
                    // Count elected officials
                    let electedCount = 0;
                    for (const [level, levelOfficials] of Object.entries(grouped)) {
                        electedCount += levelOfficials.length;
                    }
                    
                    showStatus(`Found ${electedCount} elected representatives for your address`, 'success');
                    
                    // Display results
                    let html = '<div style="text-align: center; margin-bottom: 20px; color: #004aad; font-weight: 600;">Showing ELECTED Officials Only (Local → State → Federal)</div>';
                    
                    const displayOrder = [
                        'School Board',
                        'City/Town/Local', 
                        'County', 
                        'State Legislative',
                        'State Executive',
                        'Federal Legislative',
                        'Federal Executive'
                    ];
                    
                    for (const level of displayOrder) {
                        const levelOfficials = grouped[level];
                        if (levelOfficials && levelOfficials.length > 0) {
                            html += createLevelSection(level, levelOfficials);
                        }
                    }
                    
                    resultsDiv.innerHTML = html;
                    
                    // Show timestamp of the results
                    const timestamp = new Date().toLocaleString();
                    resultsDiv.innerHTML += `
                        <div class="kmr-status info" style="margin-top: 20px;">
                            <strong>Data Timestamp:</strong> ${timestamp}
                        </div>
                    `;
                    
                    // Verify missing data using alternative databases
                    checkMissingData(officials);
                    
                } else {
                    showStatus('No representatives found for this address.', 'error');
                }
                
            } catch (error) {
                console.error('Error displaying results:', error);
                showError('Error displaying results. Please try again later.');
            }
        }

        function checkMissingData(officials) {
            const missingDataOfficials = officials.filter(official => {
                // Check for missing critical fields like photo, contact info, or term details
                return !official.photo_origin_url || !official.email_addresses || !official.term_start || !official.term_end;
            });

            if (missingDataOfficials.length > 0) {
                // Provide links for additional resources
                let html = `
                    <div class="kmr-status info" style="margin-top: 20px;">
                        <strong>Additional Resources:</strong> The following missing data can be cross-verified from alternative databases:
                    </div>
                    <ul>
                `;
                missingDataOfficials.forEach(official => {
                    const officialState = extractStateFromAddress(official.address);
                    html += `
                        <li>
                            <a href="${getAlternativeLink(officialState)}" target="_blank">
                                Check additional details for ${official.first_name} ${official.last_name}
                            </a>
                        </li>
                    `;
                });
                html += '</ul>';
                document.getElementById('resultsDiv').innerHTML += html;
            }
        }

        function getAlternativeLink(state) {
            // Return appropriate alternative database link based on state
            if (state === 'MD') {
                return 'https://www.maryland.gov/pages/nearme.aspx';
            } else if (state === 'VA') {
                return 'https://whosmy.virginiageneralassembly.gov/';
            } else if (state === 'DC') {
                return 'https://dccouncil.gov/councilmembers/';
            } else {
                return 'https://openstates.org/find_your_legislator/';
            }
        }

        function groupOfficialsByLevel(officials) {
            const groups = {
                'School Board': [],
                'City/Town/Local': [],
                'County': [],
                'State Legislative': [],
                'State Executive': [],
                'Federal Legislative': [],
                'Federal Executive': []
            };
            
            officials.forEach(official => {
                const office = official.office || {};
                const officeName = (office.name || '').toLowerCase();
                
                // Group officials by office level
                if (officeName.match(/school board/i)) {
                    groups['School Board'].push(official);
                } else if (officeName.match(/mayor|city council/i)) {
                    groups['City/Town/Local'].push(official);
                } else if (officeName.match(/county executive/i)) {
                    groups['County'].push(official);
                } else if (officeName.match(/state senator|state representative/i)) {
                    groups['State Legislative'].push(official);
                } else if (officeName.match(/governor|lieutenant governor/i)) {
                    groups['State Executive'].push(official);
                } else if (officeName.match(/senator|representative/i)) {
                    groups['Federal Legislative'].push(official);
                } else if (officeName.match(/president|vice president/i)) {
                    groups['Federal Executive'].push(official);
                }
            });
            
            return groups;
        }

        function createLevelSection(level, officials) {
            let html = `
                <div class="kmr-level-section">
                    <h2 class="kmr-level-title">${level} (${officials.length})</h2>
                    <div class="kmr-officials-grid">
            `;
            
            officials.forEach(official => {
                const name = `${official.first_name} ${official.last_name}` || 'Name Not Available';
                const officeName = official.office?.name || 'Office Not Specified';
                const termStart = official.term_start || 'N/A';
                const termEnd = official.term_end || 'N/A';
                
                html += `
                    <div class="kmr-official-card">
                        <div class="kmr-official-name">${name}</div>
                        <div class="kmr-official-office">${officeName}</div>
                        <div style="font-size: 0.9em; color: #666;">Term: ${termStart} - ${termEnd}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `kmr-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showError(message) {
            const resultsDiv = document.getElementById('resultsDiv');
            resultsDiv.innerHTML = `<div class="kmr-error">${message}</div>`;
            showStatus(message, 'error');
        }
    </script>
</body>
</html>
