<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Know My Rep - Find Your Representatives</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .kmr-container {
            max-width: 600px;
            width: 100%;
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .kmr-hero {
            text-align: center;
            margin-bottom: 30px;
        }

        .kmr-hero h1 {
            font-size: 36px;
            font-weight: 700;
            color: #004aad;
            margin-bottom: 10px;
        }

        .kmr-hero p {
            font-size: 18px;
            color: #666;
        }

        .kmr-search-box {
            width: 100%;
            text-align: center;
        }

        .kmr-input-group {
            margin-bottom: 20px;
        }

        .kmr-input {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            border: 2px solid #004aad;
            border-radius: 8px;
            margin-bottom: 20px;
            box-sizing: border-box;
            outline: none;
            transition: border 0.3s;
        }

        .kmr-input:focus {
            border-color: #006bb3;
            box-shadow: 0 0 5px rgba(0, 107, 179, 0.5);
        }

        .kmr-btn {
            background-color: #004aad;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .kmr-btn:hover {
            background-color: #006bb3;
            transform: translateY(-2px);
        }

        .kmr-status {
            text-align: center;
            margin-top: 30px;
            font-size: 16px;
            color: #004aad;
        }

        .kmr-loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .kmr-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #004aad;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .kmr-officials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .kmr-official-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #004aad;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .kmr-official-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .kmr-official-name {
            font-size: 20px;
            font-weight: 600;
            color: #000;
            margin-bottom: 10px;
        }

        .kmr-official-office {
            color: #004aad;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .kmr-official-party {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .party-democrat {
            background: #0015BC;
            color: white;
        }

        .party-republican {
            background: #FF0000;
            color: white;
        }

        .party-independent {
            background: #808080;
            color: white;
        }

        .kmr-official-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
        }

        .kmr-official-contact {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .kmr-contact-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
        }

        .kmr-contact-item strong {
            min-width: 60px;
            color: #000;
            margin-right: 10px;
        }

        .kmr-contact-item a {
            color: #004aad;
            text-decoration: none;
        }

        .kmr-contact-item a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .kmr-hero h1 {
                font-size: 2em;
            }

            .kmr-input {
                font-size: 16px;
                padding: 15px;
            }

            .kmr-btn {
                font-size: 16px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="kmr-container">
        <div class="kmr-hero">
            <h1>Know My Rep</h1>
            <p>Enter your address to find your elected representatives </p>
        </div>

        <div class="kmr-search-box">
            <div class="kmr-input-group">
                <input type="text" 
                       id="addressInput" 
                       class="kmr-input" 
                       placeholder="Enter your full address (e.g., 123 Main St, Baltimore, MD 21201)"
                       value="">
            </div>
            <div>
                <button onclick="findRepresentatives()" class="kmr-btn kmr-btn-primary">
                    Find My Representatives
                </button>
            </div>
            <div id="statusMessage"></div>
        </div>

        <div id="loadingDiv" class="kmr-loading" style="display: none;">
            <div class="kmr-spinner"></div>
            <p>Finding your representatives...</p>
        </div>

        <div id="resultsDiv"></div>
    </div>

    <script>
        const CICERO_API_KEY = 'ccc7f60c9d8d5ccc0f7c849e754f5aef78ff706c';
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
            'https://cors.bridged.cc/',
            'https://cors-anywhere.herokuapp.com/'
        ];

        let currentProxyIndex = 0;

        async function findRepresentatives() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showStatus('Please enter your address', 'error');
                return;
            }

            if (!CICERO_API_KEY || CICERO_API_KEY.length < 30) {
                showStatus('Error: Invalid Cicero API key configuration.', 'error');
                return;
            }

            const loadingDiv = document.getElementById('loadingDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            showStatus('Searching for your representatives...', 'info');

            try {
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=us&limit=1`;
                const geoResponse = await fetch(geocodeUrl);
                const geoData = await geoResponse.json();

                if (geoData && geoData.length > 0) {
                    const lat = geoData[0].lat;
                    const lon = geoData[0].lon;
                    await fetchCiceroOfficials(lat, lon, address);
                    
                } else {
                    throw new Error('Could not find that address. Please check and try again.');
                }
                
            } catch (error) {
                console.error('Error:', error);
                loadingDiv.style.display = 'none';
                showError(error.message || 'Could not fetch representatives. Please try again later.');
            }
        }

        async function fetchCiceroOfficials(lat, lon, address) {
            const ciceroUrl = `https://cicero.azavea.com/v3.1/official?lat=${lat}&lon=${lon}&format=json&key=${CICERO_API_KEY}&includechildren=1&order=asc`;
            
            let success = false;
            let lastError = null;

            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxy = CORS_PROXIES[currentProxyIndex];
                const proxyUrl = proxy + encodeURIComponent(ciceroUrl);
                
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                    });

                    const text = await response.text();
                    let data;
                    
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        throw new Error('Invalid response from API');
                    }

                    if (data.response && data.response.results) {
                        displayCiceroResults(data, address);
                        success = true;
                        break;
                    }
                    
                } catch (error) {
                    lastError = error;
                    currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
                }
            }

            if (!success) {
                document.getElementById('loadingDiv').style.display = 'none';
                showError('Could not connect to Cicero API. Please try again later.');
            }
        }

        function displayCiceroResults(data, address) {
            const loadingDiv = document.getElementById('loadingDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            
            loadingDiv.style.display = 'none';
            
            try {
                const officials = data.response.results.officials || [];
                
                if (officials.length > 0) {
                    const grouped = groupOfficialsByLevel(officials);
                    let electedCount = 0;

                    for (const [level, levelOfficials] of Object.entries(grouped)) {
                        electedCount += levelOfficials.length;
                    }

                    showStatus(`Found ${electedCount} elected representatives for your address`, 'success');
                    
                    let html = '<div style="text-align: center; margin-bottom: 20px; color: #004aad; font-weight: 600;">Showing ELECTED Officials Only (Local → State → Federal)</div>';
                    
                    const displayOrder = [
                        'School Board', 'City/Town/Local', 'County', 'State Legislative', 'State Executive', 'Federal Legislative', 'Federal Executive'
                    ];
                    
                    for (const level of displayOrder) {
                        const levelOfficials = grouped[level];
                        if (levelOfficials && levelOfficials.length > 0) {
                            html += createLevelSection(level, levelOfficials);
                        }
                    }
                    
                    resultsDiv.innerHTML = html;
                    
                    const timestamp = new Date().toLocaleString();
                    resultsDiv.innerHTML += `
                        <div class="kmr-status info" style="margin-top: 20px;">
                            <strong>Data Timestamp:</strong> ${timestamp}
                        </div>
                    `;
                    
                } else {
                    showStatus('No representatives found for this address.', 'error');
                }
                
            } catch (error) {
                showError('Error displaying results. Please try again later.');
            }
        }

        function groupOfficialsByLevel(officials) {
            const groups = {
                'School Board': [],
                'City/Town/Local': [],
                'County': [],
                'State Legislative': [],
                'State Executive': [],
                'Federal Legislative': [],
                'Federal Executive': []
            };
            
            officials.forEach(official => {
                const office = official.office || {};
                const officeName = (office.name || '').toLowerCase();
                
                if (officeName.match(/school board/i)) {
                    groups['School Board'].push(official);
                } else if (officeName.match(/mayor|city council/i)) {
                    groups['City/Town/Local'].push(official);
                } else if (officeName.match(/county executive/i)) {
                    groups['County'].push(official);
                } else if (officeName.match(/state senator|state representative/i)) {
                    groups['State Legislative'].push(official);
                } else if (officeName.match(/governor|lieutenant governor/i)) {
                    groups['State Executive'].push(official);
                } else if (officeName.match(/senator|representative/i)) {
                    groups['Federal Legislative'].push(official);
                } else if (officeName.match(/president|vice president/i)) {
                    groups['Federal Executive'].push(official);
                }
            });
            
            return groups;
        }

        function createLevelSection(level, officials) {
            let html = `
                <div class="kmr-level-section">
                    <h2 class="kmr-level-title">${level} (${officials.length})</h2>
                    <div class="kmr-officials-grid">
            `;
            
            officials.forEach(official => {
                const name = `${official.first_name} ${official.last_name}` || 'Name Not Available';
                const officeName = official.office?.name || 'Office Not Specified';
                const termStart = official.term_start || 'N/A';
                const termEnd = official.term_end || 'N/A';
                
                html += `
                    <div class="kmr-official-card">
                        <div class="kmr-official-name">${name}</div>
                        <div class="kmr-official-office">${officeName}</div>
                        <div style="font-size: 0.9em; color: #666;">Term: ${termStart} - ${termEnd}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `kmr-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showError(message) {
            const resultsDiv = document.getElementById('resultsDiv');
            resultsDiv.innerHTML = `<div class="kmr-error">${message}</div>`;
            showStatus(message, 'error');
        }
    </script>
</body>
</html>
