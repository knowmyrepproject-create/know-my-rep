<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Know My Rep - Find Your Representatives</title>
    <style>
        /* Add your existing styles here */
    </style>
</head>
<body>
    <div class="kmr-container">
        <div class="kmr-hero">
            <h1>Know My Rep</h1>
            <p>Find ALL Your Elected Representatives - Local to Federal</p>
        </div>

        <div class="kmr-search-box">
            <div class="kmr-input-group">
                <input type="text" 
                       id="addressInput" 
                       class="kmr-input" 
                       placeholder="Enter your full address (e.g., 123 Main St, Baltimore, MD 21201)"
                       value="">
            </div>
            <div style="text-align: center;">
                <button id="searchButton" onclick="findRepresentatives()" class="kmr-btn kmr-btn-primary">
                    Find My Representatives
                </button>
            </div>
            <div id="statusMessage"></div>
        </div>

        <div id="loadingDiv" class="kmr-loading" style="display: none;">
            <div class="kmr-spinner"></div>
            <p id="loadingText">Finding your representatives...</p>
        </div>

        <div id="resultsDiv"></div>
        <div id="alternativesDiv"></div>
    </div>

    <script>
        // ============================================
        // MAIN SEARCH FUNCTION
        // ============================================
        
        async function findRepresentatives() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                showStatus('Please enter your address', 'error');
                return;
            }

            const searchButton = document.getElementById('searchButton');
            const loadingDiv = document.getElementById('loadingDiv');
            const loadingText = document.getElementById('loadingText');
            const resultsDiv = document.getElementById('resultsDiv');
            const alternativesDiv = document.getElementById('alternativesDiv');
            
            searchButton.disabled = true;
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            alternativesDiv.innerHTML = '';
            showStatus('Searching for your representatives...', 'info');

            try {
                // Step 1: Geocode the address
                loadingText.textContent = 'Locating address...';
                showStatus('Locating address...', 'info');
                
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=us&limit=1`;
                
                const geoResponse = await fetch(geocodeUrl, {
                    headers: {
                        'User-Agent': 'KnowMyRep/1.0'
                    }
                });
                const geoData = await geoResponse.json();

                if (geoData && geoData.length > 0) {
                    const lat = geoData[0].lat;
                    const lon = geoData[0].lon;
                    const displayName = geoData[0].display_name;
                    
                    console.log('Location found:', displayName);
                    showStatus(`Found location: ${displayName}`, 'success');
                    
                    // Step 2: Fetch all officials dynamically
                    loadingText.textContent = 'Retrieving elected officials...';
                    const allOfficials = await fetchAllOfficials(lat, lon, address);
                    displayCombinedResults(allOfficials, address);
                    
                } else {
                    throw new Error('Could not find that address. Please check and try again.');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Unable to search. Please try the manual lookup tools below.');
                showAlternatives();
            } finally {
                searchButton.disabled = false;
                loadingDiv.style.display = 'none';
            }
        }

        async function fetchAllOfficials(lat, lon, address) {
            let allOfficials = [];
            
            // Fetch from dynamic election data API (e.g., Cicero, Democracy Works, etc.)
            showStatus('Searching dynamic data sources...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/get-representatives', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ lat, lon, address })
                });
                
                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status}`);
                }
                
                const data = await response.json();
                if (data && data.response && data.response.results && data.response.results.officials) {
                    const ciceroOfficials = data.response.results.officials;
                    allOfficials = ciceroOfficials.map(official => ({
                        ...official,
                        source: 'dynamic'
                    }));
                } else {
                    console.log('No officials found in dynamic data source');
                }
                
            } catch (error) {
                console.error('Error fetching from dynamic data source:', error);
                showStatus('Dynamic data source unavailable, showing federal officials only', 'info');
            }
            
            // Fetch additional officials dynamically based on geolocation
            const federalOfficials = await getFederalOfficials(address);
            allOfficials = allOfficials.concat(federalOfficials);
            
            return allOfficials;
        }

        // Fetch federal officials (U.S. Congress, Senate, President, etc.)
        async function getFederalOfficials(address) {
            const state = extractStateFromAddress(address);
            if (!state) return [];
            
            const federalAPI = `https://api.propublica.org/congress/v1/members.json?state=${state}`;
            const response = await fetch(federalAPI, {
                headers: { 'X-API-Key': 'YOUR_PROPUBLICA_API_KEY' }
            });
            const data = await response.json();

            const federalOfficials = [];
            if (data && data.results) {
                data.results.forEach(official => {
                    federalOfficials.push({
                        first_name: official.first_name,
                        last_name: official.last_name,
                        party: official.party,
                        office: {
                            name: official.title,
                            district: { district_type: 'federal', district_id: state }
                        },
                        source: 'federal'
                    });
                });
            }
            return federalOfficials;
        }

        function extractStateFromAddress(address) {
            const statePattern = /\b(MD|VA|DC|AL|AK|AZ|AR|CA|CO|CT|DE|FL|GA|HI|ID|IL|IN|IA|KS|KY|LA|ME|MA|MI|MN|MS|MO|MT|NE|NV|NH|NJ|NM|NY|NC|ND|OH|OK|OR|PA|RI|SC|SD|TN|TX|UT|VT|WA|WV|WI|WY)\b/i;
            const match = address.match(statePattern);
            return match ? match[1].toUpperCase() : null;
        }

        function displayCombinedResults(allOfficials, address) {
            const resultsDiv = document.getElementById('resultsDiv');
            
            const grouped = groupOfficialsByLevel(allOfficials);
            
            let html = '';
            
            const displayOrder = ['School Board', 'City/Town/Local', 'County', 'State Legislative', 'State Executive', 'Federal Legislative', 'Federal Executive'];
            
            for (const level of displayOrder) {
                const levelOfficials = grouped[level];
                if (levelOfficials && levelOfficials.length > 0) {
                    html += createLevelSection(level, levelOfficials);
                }
            }
            
            if (html === '') {
                html = `
                    <div class="kmr-error">
                        <strong>No representatives found automatically.</strong><br>
                        This may be due to database limitations or connectivity issues.
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            showAlternatives();
        }

        function groupOfficialsByLevel(officials) {
            const groups = {
                'School Board': [],
                'City/Town/Local': [],
                'County': [],
                'State Legislative': [],
                'State Executive': [],
                'Federal Legislative': [],
                'Federal Executive': []
            };

            officials.forEach(official => {
                const officeName = (official.office && official.office.name || '').toLowerCase();
                if (officeName.includes('school board') || officeName.includes('education')) {
                    groups['School Board'].push(official);
                } else if (officeName.includes('mayor') || officeName.includes('city council') || officeName.includes('town council')) {
                    groups['City/Town/Local'].push(official);
                } else if (officeName.includes('county') || officeName.includes('county council')) {
                    groups['County'].push(official);
                } else if (officeName.includes('governor') || officeName.includes('attorney general')) {
                    groups['State Executive'].push(official);
                } else if (officeName.includes('state senator') || officeName.includes('state delegate')) {
                    groups['State Legislative'].push(official);
                } else if (officeName.includes('u.s. senator') || officeName.includes('congress')) {
                    groups['Federal Legislative'].push(official);
                } else if (officeName.includes('president') || officeName.includes('vice president')) {
                    groups['Federal Executive'].push(official);
                }
            });
            return groups;
        }

        function createLevelSection(level, officials) {
            const levelTitles = {
                'School Board': 'üè´ School Board',
                'City/Town/Local': 'üèòÔ∏è City/Town/Local',
                'County': 'üèõÔ∏è County',
                'State Legislative': 'üèõÔ∏è State Legislature',
                'State Executive': 'üèõÔ∏è State Executive',
                'Federal Legislative': 'üá∫üá∏ U.S. Congress',
                'Federal Executive': 'üá∫üá∏ Federal Executive'
            };
            
            let html = `
                <div class="kmr-level-section">
                    <h2 class="kmr-level-title">${levelTitles[level]} (${officials.length})</h2>
                    <div class="kmr-officials-grid">
            `;
            
            officials.forEach(official => {
                const fullName = `${official.first_name || ''} ${official.last_name || ''}`.trim();
                const officeName = official.office ? official.office.name : 'Elected Official';
                const party = official.party || 'N/A';
                
                html += `
                    <div class="kmr-official-card">
                        <div class="kmr-official-name">${fullName}</div>
                        <div class="kmr-official-office">${officeName}</div>
                        <div class="kmr-official-party">${party}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `kmr-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showAlternatives() {
            const alternativesDiv = document.getElementById('alternativesDiv');
            alternativesDiv.innerHTML = `
                <div class="kmr-alternatives">
                    <h2>Find Missing Officials</h2>
                    <p>Use these resources to find missing officials:</p>
                    <a href="https://www.usa.gov/elected-officials" target="_blank" class="kmr-alt-link">USA.gov Directory</a>
                    <a href="https://www.ballotpedia.org" target="_blank" class="kmr-alt-link">Ballotpedia</a>
                </div>
            `;
        }

        // Initialize - add enter key support
        window.addEventListener('load', () => {
            console.log('Know My Rep loaded with dynamic data integration');
            document.getElementById('addressInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    findRepresentatives();
                }
            });
        });
    </script>
</body>
</html>
