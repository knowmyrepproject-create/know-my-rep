<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Know My Rep - Find Your Representatives</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ample Display', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .kmr-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .kmr-hero {
            background: linear-gradient(135deg, #004aad 0%, #002d6d 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 74, 173, 0.3);
        }

        .kmr-hero h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .kmr-hero p {
            font-size: 1.2em;
            opacity: 0.95;
            font-weight: 300;
        }

        .kmr-search-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .kmr-input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .kmr-input {
            flex: 1;
            min-width: 250px;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .kmr-input:focus {
            outline: none;
            border-color: #004aad;
            box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.1);
        }

        .kmr-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kmr-btn-primary {
            background: #eb3a3a;
            color: white;
            box-shadow: 0 4px 15px rgba(235, 58, 58, 0.3);
            min-width: 250px;
        }

        .kmr-btn-primary:hover {
            background: #d62828;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(235, 58, 58, 0.4);
        }

        .kmr-btn-primary:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        .kmr-loading {
            text-align: center;
            padding: 40px;
            color: #004aad;
        }

        .kmr-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #004aad;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .kmr-results {
            display: grid;
            gap: 20px;
        }

        .kmr-level-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .kmr-level-title {
            color: #004aad;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #eb3a3a;
            font-weight: 700;
            text-transform: uppercase;
        }

        .kmr-officials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .kmr-official-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #004aad;
            transition: all 0.3s ease;
        }

        .kmr-official-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .kmr-official-card.enhanced {
            border-left-color: #28a745;
        }

        .kmr-official-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #000;
            margin-bottom: 5px;
        }

        .kmr-official-office {
            color: #eb3a3a;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .kmr-official-party {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .party-democrat, .party-democratic {
            background: #0015BC;
            color: white;
        }

        .party-republican {
            background: #FF0000;
            color: white;
        }

        .party-independent, .party-green, .party-libertarian, .party-nonpartisan {
            background: #808080;
            color: white;
        }

        .kmr-official-contact {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .kmr-contact-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
        }

        .kmr-contact-item strong {
            min-width: 60px;
            color: #000;
            margin-right: 10px;
        }

        .kmr-contact-item a {
            color: #004aad;
            text-decoration: none;
        }

        .kmr-contact-item a:hover {
            text-decoration: underline;
        }

        .kmr-official-bio {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }

        .kmr-error {
            background: #fee;
            border: 2px solid #eb3a3a;
            color: #d62828;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .kmr-status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .kmr-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .kmr-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .kmr-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .kmr-alternatives {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }

        .kmr-alternatives h2 {
            color: #004aad;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .kmr-alternatives h3 {
            color: #004aad;
            margin: 25px 0 15px;
            font-size: 1.3em;
        }

        .kmr-alt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .kmr-alt-link {
            display: block;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-decoration: none;
            color: #004aad;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
        }

        .kmr-alt-link:hover {
            border-color: #004aad;
            background: #e6f2ff;
            transform: translateY(-2px);
        }

        .kmr-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .kmr-data-source {
            font-size: 0.8em;
            color: #28a745;
            margin-left: 10px;
            font-weight: normal;
        }

        @media (max-width: 768px) {
            .kmr-hero h1 {
                font-size: 1.8em;
            }
            
            .kmr-input-group {
                flex-direction: column;
            }
            
            .kmr-input {
                min-width: 100%;
            }

            .kmr-officials-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="kmr-container">
        <div class="kmr-hero">
            <h1>Know My Rep</h1>
            <p>Find ALL Your Elected Representatives - Local to Federal</p>
        </div>

        <div class="kmr-search-box">
            <div class="kmr-input-group">
                <input type="text" 
                       id="addressInput" 
                       class="kmr-input" 
                       placeholder="Enter your full address (e.g., 123 Main St, Baltimore, MD 21201)"
                       value="">
            </div>
            <div style="text-align: center;">
                <button id="searchButton" onclick="findRepresentatives()" class="kmr-btn kmr-btn-primary">
                    Find My Representatives
                </button>
            </div>
            <div id="statusMessage"></div>
            <div style="margin-top: 15px; font-size: 0.85em; color: #666; text-align: center;">
                Searches government databases for comprehensive elected official information
            </div>
        </div>

        <div id="loadingDiv" class="kmr-loading" style="display: none;">
            <div class="kmr-spinner"></div>
            <p id="loadingText">Finding your representatives...</p>
        </div>

        <div id="resultsDiv"></div>
        <div id="alternativesDiv"></div>
    </div>

    <script>
        // ============================================
        // MAIN SEARCH FUNCTION
        // ============================================
        async function findRepresentatives() {
            const address = document.getElementById('addressInput').value.trim();
            
            if (!address) {
                showError('Please enter your address');
                return;
            }
            
            // Show loading
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultsDiv').innerHTML = '';
            document.getElementById('alternativesDiv').innerHTML = '';
            document.getElementById('statusMessage').innerHTML = '';
            
            // Disable button during search
            const searchButton = document.getElementById('searchButton');
            searchButton.disabled = true;
            
            try {
                // Geocode the address
                showStatus('Locating address...', 'info');
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=us&limit=1`;
                
                const geoResponse = await fetch(geocodeUrl);
                const geoData = await geoResponse.json();
                
                if (!geoData || geoData.length === 0) {
                    throw new Error('Could not find that address. Please check and try again.');
                }
                
                const lat = geoData[0].lat;
                const lon = geoData[0].lon;
                
                console.log(`Address geocoded to: ${lat}, ${lon}`);
                
                // Fetch all officials (Cicero + Maryland data + Federal)
                const allOfficials = await fetchAllOfficials(lat, lon, address);
                
                // Display combined results
                displayCombinedResults(allOfficials, address);
                
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'An error occurred. Please try again.');
                showAlternatives();
            } finally {
                // Re-enable button and hide loading
                searchButton.disabled = false;
                document.getElementById('loadingDiv').style.display = 'none';
            }
        }

        async function fetchAllOfficials(lat, lon, address) {
            let allOfficials = [];
            
            // Fetch from Cicero via our backend
            showStatus('Searching official databases...', 'info');
            
            try {
                console.log('Calling backend function at /.netlify/functions/get-representatives');
                
                const response = await fetch('/.netlify/functions/get-representatives', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ lat, lon, address })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.response && data.response.results && data.response.results.officials) {
                        const ciceroOfficials = data.response.results.officials;
                        console.log(`Found ${ciceroOfficials.length} officials from Cicero`);
                        allOfficials = ciceroOfficials.map(official => ({
                            ...official,
                            source: 'cicero'
                        }));
                    }
                }
            } catch (error) {
                console.error('Error fetching from backend:', error);
            }
            
            // Fetch and merge Maryland officials data
            const state = extractStateFromAddress(address);
            if (state === 'MD') {
                try {
                    console.log('Fetching Maryland officials from /data/maryland-officials.json...');
                    const mdResponse = await fetch('/data/maryland-officials.json');
                    
                    console.log('🔍 Maryland data response status:', mdResponse.status);
                    console.log('🔍 Response OK?:', mdResponse.ok);
                    
                    if (mdResponse.ok) {
                        const mdData = await mdResponse.json();
                        console.log(`✅ Successfully loaded ${mdData.length} Maryland officials from JSON`);
                        
                        // Log first few officials to verify data structure
                        if (mdData.length > 0) {
                            console.log('Sample Maryland officials:', mdData.slice(0, 3).map(o => ({
                                name: o.name,
                                position: o.position,
                                first_name: o.first_name,
                                last_name: o.last_name
                            })));
                        }
                        
                        // Track what we're doing
                        let enhanced = 0;
                        let added = 0;
                        
                        // Merge strategy: enhance existing officials and add missing ones
                        mdData.forEach(mdOfficial => {
                            // Check if this official already exists in Cicero data
                            const existingIndex = allOfficials.findIndex(o => 
                                o.first_name?.toLowerCase() === mdOfficial.first_name?.toLowerCase() &&
                                o.last_name?.toLowerCase() === mdOfficial.last_name?.toLowerCase()
                            );
                            
                            if (existingIndex >= 0) {
                                // Enhance existing official with better data
                                enhanced++;
                                const existing = allOfficials[existingIndex];
                                existing.phone = mdOfficial.phone || existing.phone;
                                existing.email_addresses = mdOfficial.email ? [mdOfficial.email] : existing.email_addresses;
                                existing.urls = mdOfficial.website ? [mdOfficial.website] : existing.urls;
                                existing.bio = mdOfficial.bio_short;
                                existing.committees = mdOfficial.committees;
                                existing.enhanced = true;
                                
                                // Fix office name if it's generic - CHECK FOR "Elected Official" TOO!
                                if (existing.office && (existing.office.name === 'Office' || 
                                                        existing.office.name === 'Elected Official' || 
                                                        !existing.office.name)) {
                                    existing.office.name = mdOfficial.position;
                                    console.log(`Fixed title for ${mdOfficial.name}: ${mdOfficial.position}`);
                                }
                            } else {
                                // Add new official not in Cicero
                                added++;
                                console.log(`Adding new official: ${mdOfficial.name} - ${mdOfficial.position}`);
                                allOfficials.push({
                                    first_name: mdOfficial.first_name,
                                    last_name: mdOfficial.last_name,
                                    party: mdOfficial.party,
                                    office: {
                                        name: mdOfficial.position,
                                        district: {
                                            district_type: mdOfficial.government_level?.toLowerCase(),
                                            district_id: mdOfficial.district_ward
                                        }
                                    },
                                    email_addresses: mdOfficial.email ? [mdOfficial.email] : [],
                                    urls: mdOfficial.website ? [mdOfficial.website] : [],
                                    addresses: mdOfficial.address ? [{
                                        phone: mdOfficial.phone,
                                        address: mdOfficial.address
                                    }] : [],
                                    phone: mdOfficial.phone,
                                    bio: mdOfficial.bio_short,
                                    committees: mdOfficial.committees,
                                    source: 'maryland_data',
                                    enhanced: true
                                });
                            }
                        });
                        
                        console.log(`✅ Enhanced ${enhanced} officials, Added ${added} new officials`);
                        showStatus(`Enhanced with Maryland data (${added} new officials added)`, 'success');
                    } else {
                        console.error('❌ Failed to load Maryland data. Status:', mdResponse.status);
                        console.error('URL attempted:', '/data/maryland-officials.json');
                        if (mdResponse.status === 404) {
                            console.error('File not found! Check if data/maryland-officials.json exists in your GitHub repo');
                        }
                    }
                } catch (error) {
                    console.error('❌ Error loading Maryland data:', error);
                    console.log('Maryland data not available, using Cicero only');
                }
            } else {
                console.log(`State is ${state}, not MD - skipping Maryland data`);
            }
            
            // Add hardcoded federal officials as final fallback
            const federalOfficials = await getFederalOfficials(address);
            
            // Only add federal officials if not already present
            federalOfficials.forEach(fed => {
                const exists = allOfficials.some(o => 
                    o.first_name === fed.first_name && 
                    o.last_name === fed.last_name
                );
                if (!exists) {
                    allOfficials.push(fed);
                }
            });
            
            console.log(`✅ Total officials after merging: ${allOfficials.length}`);
            return allOfficials;
        }

        async function getFederalOfficials(address) {
            const state = extractStateFromAddress(address);
            if (!state) return [];
            
            const federalOfficials = [
                {
                    first_name: 'Donald',
                    last_name: 'Trump',
                    party: 'Republican',
                    office: {
                        name: 'President of the United States',
                        district: { district_type: 'federal', district_id: '' }
                    },
                    source: 'federal'
                },
                {
                    first_name: 'JD',
                    last_name: 'Vance',
                    party: 'Republican',
                    office: {
                        name: 'Vice President of the United States',
                        district: { district_type: 'federal', district_id: '' }
                    },
                    source: 'federal'
                }
            ];
            
            // Add senators based on state
            const senators = getFederalSenators(state);
            return federalOfficials.concat(senators);
        }

        function getFederalSenators(state) {
            const senatorsByState = {
                'MD': [
                    { first_name: 'Ben', last_name: 'Cardin', party: 'Democratic' },
                    { first_name: 'Chris', last_name: 'Van Hollen', party: 'Democratic' }
                ],
                'VA': [
                    { first_name: 'Mark', last_name: 'Warner', party: 'Democratic' },
                    { first_name: 'Tim', last_name: 'Kaine', party: 'Democratic' }
                ],
                'DC': [],
                'NY': [
                    { first_name: 'Chuck', last_name: 'Schumer', party: 'Democratic' },
                    { first_name: 'Kirsten', last_name: 'Gillibrand', party: 'Democratic' }
                ],
                'CA': [
                    { first_name: 'Alex', last_name: 'Padilla', party: 'Democratic' },
                    { first_name: 'Adam', last_name: 'Schiff', party: 'Democratic' }
                ],
                'TX': [
                    { first_name: 'John', last_name: 'Cornyn', party: 'Republican' },
                    { first_name: 'Ted', last_name: 'Cruz', party: 'Republican' }
                ],
                'FL': [
                    { first_name: 'Marco', last_name: 'Rubio', party: 'Republican' },
                    { first_name: 'Rick', last_name: 'Scott', party: 'Republican' }
                ]
            };
            
            const senators = senatorsByState[state] || [];
            
            return senators.map(senator => ({
                ...senator,
                office: {
                    name: `U.S. Senator from ${state}`,
                    district: { district_type: 'federal', district_id: state }
                },
                source: 'federal'
            }));
        }

        function displayCombinedResults(allOfficials, address) {
            const resultsDiv = document.getElementById('resultsDiv');
            
            // Remove duplicates
            const uniqueOfficials = [];
            const seen = new Set();
            
            allOfficials.forEach(official => {
                const key = `${official.first_name}-${official.last_name}-${official.office?.name}`.toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueOfficials.push(official);
                }
            });
            
            // Group officials by level  
            const grouped = groupOfficialsByLevel(uniqueOfficials);
            
            // Count ELECTED officials only
            let electedCount = 0;
            let enhancedCount = 0;
            for (const [level, levelOfficials] of Object.entries(grouped)) {
                electedCount += levelOfficials.length;
                enhancedCount += levelOfficials.filter(o => o.enhanced).length;
            }
            
            if (electedCount > 0) {
                let statusMsg = `Found ${electedCount} elected representatives`;
                if (enhancedCount > 0) {
                    statusMsg += ` (${enhancedCount} with enhanced data)`;
                }
                showStatus(statusMsg, 'success');
            } else {
                showStatus('Limited results. Please check manual lookup tools below.', 'error');
            }
            
            // Build HTML
            let html = '';
            
            if (electedCount === 0) {
                html = `
                    <div class="kmr-error">
                        <strong>No representatives found automatically.</strong><br>
                        This may be due to database limitations or connectivity issues.<br>
                        Please use the manual lookup tools below.
                    </div>
                `;
            } else {
                html = '<div style="text-align: center; margin-bottom: 20px; color: #004aad; font-weight: 600;">Your Elected Representatives</div>';
                
                const displayOrder = [
                    'School Board',
                    'City/Town/Local', 
                    'County', 
                    'State Legislative',
                    'State Executive',
                    'Federal Legislative',
                    'Federal Executive'
                ];
                
                for (const level of displayOrder) {
                    const levelOfficials = grouped[level];
                    if (levelOfficials && levelOfficials.length > 0) {
                        html += createLevelSection(level, levelOfficials);
                    }
                }
                
                // Add note about what's missing if we don't have school board
                if (!grouped['School Board'] || grouped['School Board'].length === 0) {
                    html += `
                        <div class="kmr-note">
                            <strong>Note:</strong> Some positions may not appear above:
                            <ul style="margin-top: 10px; margin-left: 20px;">
                                <li>School Board members (if not in our database)</li>
                                <li>Some hyper-local officials</li>
                            </ul>
                            Please use the resources below to find any missing officials.
                        </div>
                    `;
                }
            }
            
            resultsDiv.innerHTML = html;
            
            // Always show alternatives
            showAlternatives();
        }

        function groupOfficialsByLevel(officials) {
            const groups = {
                'School Board': [],
                'City/Town/Local': [],
                'County': [],
                'State Legislative': [],
                'State Executive': [],
                'Federal Legislative': [],
                'Federal Executive': []
            };
            
            // List of APPOINTED positions to filter out
            const appointedPositions = [
                'secretary', 'administrator', 'director', 'commissioner',
                'chief', 'officer', 'manager', 'clerk', 'auditor',
                'inspector', 'registrar', 'marshal', 'coroner', 'treasurer',
                'assessor', 'recorder', 'surveyor', 'public defender'
            ];
            
            // Keywords for categorizing officials WITH proper title mapping
            const categoryKeywords = {
                stateExecutive: {
                    keywords: ['governor', 'lieutenant governor', 'lt. governor', 'attorney general', 'comptroller', 'treasurer'],
                    titleMap: {
                        'governor': 'Governor',
                        'lieutenant governor': 'Lieutenant Governor',
                        'lt. governor': 'Lieutenant Governor',
                        'attorney general': 'Attorney General',
                        'comptroller': 'State Comptroller',
                        'treasurer': 'State Treasurer'
                    }
                },
                stateLegislative: {
                    keywords: ['state senator', 'state delegate', 'state representative', 'house of delegates', 'state assembly', 'state house'],
                    titleMap: {
                        'state senator': 'State Senator',
                        'state delegate': 'State Delegate',
                        'state representative': 'State Representative',
                        'house of delegates': 'Member, House of Delegates',
                        'state assembly': 'State Assembly Member',
                        'state house': 'State House Representative'
                    }
                },
                county: {
                    keywords: ['county executive', 'county council', 'county commissioner', 'county board'],
                    titleMap: {
                        'county executive': 'County Executive',
                        'county council': 'County Council Member',
                        'county commissioner': 'County Commissioner',
                        'county board': 'County Board Member'
                    }
                },
                local: {
                    keywords: ['mayor', 'city council', 'town council', 'alderman', 'selectman', 'village', 'borough'],
                    titleMap: {
                        'mayor': 'Mayor',
                        'city council': 'City Council Member',
                        'town council': 'Town Council Member',
                        'alderman': 'Alderman',
                        'selectman': 'Selectman',
                        'village': 'Village Board Member',
                        'borough': 'Borough Council Member'
                    }
                },
                school: {
                    keywords: ['school board', 'board of education', 'school committee', 'school director'],
                    titleMap: {
                        'school board': 'School Board Member',
                        'board of education': 'Board of Education Member',
                        'school committee': 'School Committee Member',
                        'school director': 'School Director'
                    }
                },
                federalLegislative: {
                    keywords: ['u.s. senator', 'u.s. representative', 'united states senator', 'united states representative', 'congress'],
                    titleMap: {
                        'u.s. senator': 'U.S. Senator',
                        'u.s. representative': 'U.S. Representative',
                        'united states senator': 'U.S. Senator',
                        'united states representative': 'U.S. Representative',
                        'congress': 'Member of Congress'
                    }
                },
                federalExecutive: {
                    keywords: ['president', 'vice president'],
                    titleMap: {
                        'president': 'President of the United States',
                        'vice president': 'Vice President of the United States'
                    }
                }
            };
            
            officials.forEach(official => {
                const fullName = `${official.first_name || ''} ${official.last_name || ''}`.toLowerCase().trim();
                const office = official.office || {};
                let officeName = (office.name || '').toLowerCase();
                const originalOfficeName = office.name || ''; // Preserve original name
                const district = office.district || {};
                const districtType = (district.district_type || '').toLowerCase();
                
                // Fix generic "Office" or "Elected Official" titles if possible
                if (officeName === 'office' || officeName === 'elected official' || officeName === '') {
                    // Try to infer from district type or other context
                    if (districtType.includes('state') && districtType.includes('senate')) {
                        official.office.name = 'State Senator';
                        officeName = 'state senator';
                    } else if (districtType.includes('state') && districtType.includes('house')) {
                        official.office.name = 'State Delegate';
                        officeName = 'state delegate';
                    } else if (districtType.includes('county')) {
                        official.office.name = 'County Official';
                        officeName = 'county official';
                    } else {
                        // If we still can't determine, mark it for better handling
                        official.office.name = 'Elected Representative';
                        officeName = 'elected representative';
                    }
                } else if (!official.office.name || official.office.name === 'Office' || official.office.name === 'Elected Official') {
                    // Ensure we have a proper title based on the category
                    // This will be fixed below when we categorize
                    official.needsTitleFix = true;
                }
                
                // Check if this is an appointed position (with exceptions)
                const isAppointed = appointedPositions.some(pos => {
                    // Special exceptions for elected positions that contain these words
                    if (pos === 'commissioner' && (officeName.includes('county commissioner') || officeName.includes('election commissioner'))) return false;
                    if (pos === 'treasurer' && (officeName.includes('state treasurer') || officeName.includes('county treasurer'))) return false;
                    if (pos === 'secretary' && officeName.includes('secretary of state')) return false;
                    if (officeName.includes('attorney general')) return false;
                    if (officeName.includes('comptroller') && (officeName.includes('state') || officeName.includes('county'))) return false;
                    
                    // For generic "director" or "administrator", only filter if it's clearly administrative
                    if ((pos === 'director' || pos === 'administrator') && 
                        (officeName.includes('school') || officeName.includes('board'))) return false;
                    
                    return officeName.includes(pos) && !officeName.includes('elect');
                });
                
                if (isAppointed) {
                    console.log(`Filtering out appointed position: ${officeName}`);
                    return; // Skip this official
                }
                
                // Categorize based on office name keywords and fix titles
                let categorized = false;
                
                // Check School Board FIRST (highest priority for proper categorization)
                const schoolMatch = categoryKeywords.school.keywords.find(keyword => officeName.includes(keyword));
                if (schoolMatch) {
                    if (official.needsTitleFix || !official.office.name || official.office.name === 'Elected Official') {
                        official.office.name = categoryKeywords.school.titleMap[schoolMatch] || 'School Board Member';
                    }
                    groups['School Board'].push(official);
                    categorized = true;
                }
                // Check State Executive
                else {
                    const stateExecMatch = categoryKeywords.stateExecutive.keywords.find(keyword => officeName.includes(keyword));
                    if (stateExecMatch) {
                        if (official.needsTitleFix || !official.office.name || official.office.name === 'Elected Official') {
                            official.office.name = categoryKeywords.stateExecutive.titleMap[stateExecMatch] || originalOfficeName;
                        }
                        groups['State Executive'].push(official);
                        categorized = true;
                    }
                    // Check State Legislative
                    else {
                        const stateLegMatch = categoryKeywords.stateLegislative.keywords.find(keyword => officeName.includes(keyword));
                        if (stateLegMatch) {
                            if (official.needsTitleFix || !official.office.name || official.office.name === 'Elected Official') {
                                official.office.name = categoryKeywords.stateLegislative.titleMap[stateLegMatch] || originalOfficeName;
                            }
                            groups['State Legislative'].push(official);
                            categorized = true;
                        }
                        // Check County
                        else {
                            const countyMatch = categoryKeywords.county.keywords.find(keyword => officeName.includes(keyword));
                            if (countyMatch || (officeName.includes('county') && !officeName.includes('country'))) {
                                if (official.needsTitleFix || !official.office.name || official.office.name === 'Elected Official') {
                                    official.office.name = categoryKeywords.county.titleMap[countyMatch] || 'County Official';
                                }
                                groups['County'].push(official);
                                categorized = true;
                            }
                            // Check Federal Legislative
                            else {
                                const fedLegMatch = categoryKeywords.federalLegislative.keywords.find(keyword => officeName.includes(keyword));
                                if (fedLegMatch || (officeName.includes('senator') && districtType.includes('federal'))) {
                                    if (official.needsTitleFix || !official.office.name || official.office.name === 'Elected Official') {
                                        official.office.name = categoryKeywords.federalLegislative.titleMap[fedLegMatch] || 'Member of Congress';
                                    }
                                    groups['Federal Legislative'].push(official);
                                    categorized = true;
                                }
                                // Check Federal Executive
                                else {
                                    const fedExecMatch = categoryKeywords.federalExecutive.keywords.find(keyword => officeName.includes(keyword));
                                    if (fedExecMatch) {
                                        if (official.needsTitleFix || !official.office.name || official.office.name === 'Elected Official') {
                                            official.office.name = categoryKeywords.federalExecutive.titleMap[fedExecMatch] || originalOfficeName;
                                        }
                                        groups['Federal Executive'].push(official);
                                        categorized = true;
                                    }
                                    // Check City/Local
                                    else {
                                        const localMatch = categoryKeywords.local.keywords.find(keyword => officeName.includes(keyword));
                                        if (localMatch) {
                                            if (official.needsTitleFix || !official.office.name || official.office.name === 'Elected Official') {
                                                official.office.name = categoryKeywords.local.titleMap[localMatch] || 'Local Official';
                                            }
                                            groups['City/Town/Local'].push(official);
                                            categorized = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                // If still not categorized, try to use district type as a hint
                if (!categorized && districtType) {
                    if (districtType.includes('federal')) {
                        // Try to determine if it's House or Senate
                        if (officeName.includes('representative') || officeName.includes('house')) {
                            official.office.name = official.office.name || 'U.S. Representative';
                        } else if (officeName.includes('senator')) {
                            official.office.name = official.office.name || 'U.S. Senator';
                        } else {
                            official.office.name = official.office.name || 'Federal Official';
                        }
                        groups['Federal Legislative'].push(official);
                    } else if (districtType.includes('state')) {
                        // Try to determine if it's House or Senate
                        if (districtType.includes('senate')) {
                            official.office.name = official.office.name || 'State Senator';
                        } else if (districtType.includes('house') || districtType.includes('delegate')) {
                            official.office.name = official.office.name || 'State Delegate';
                        } else {
                            official.office.name = official.office.name || 'State Official';
                        }
                        groups['State Legislative'].push(official);
                    } else if (districtType.includes('county')) {
                        official.office.name = official.office.name || 'County Official';
                        groups['County'].push(official);
                    } else if (districtType.includes('local') || districtType.includes('city') || districtType.includes('town')) {
                        if (districtType.includes('city')) {
                            official.office.name = official.office.name || 'City Official';
                        } else if (districtType.includes('town')) {
                            official.office.name = official.office.name || 'Town Official';
                        } else {
                            official.office.name = official.office.name || 'Local Official';
                        }
                        groups['City/Town/Local'].push(official);
                    } else if (districtType.includes('school')) {
                        official.office.name = official.office.name || 'School Board Member';
                        groups['School Board'].push(official);
                    } else {
                        // Last resort - try to provide something meaningful
                        if (!official.office.name || official.office.name === 'Elected Official' || official.office.name === 'Office') {
                            official.office.name = 'Elected Representative';
                        }
                        // Log uncategorized for debugging
                        console.log(`Uncategorized official: ${fullName} - Office: "${officeName}" - District Type: "${districtType}"`);
                    }
                } else if (!categorized) {
                    // Last resort for completely uncategorized officials
                    if (!official.office.name || official.office.name === 'Elected Official' || official.office.name === 'Office') {
                        official.office.name = 'Elected Representative';
                    }
                    // Log uncategorized for debugging
                    console.log(`Uncategorized official: ${fullName} - Office: "${officeName}" - District Type: "${districtType}"`);
                }
            });
            
            return groups;
        }

        function createLevelSection(level, officials) {
            const levelTitles = {
                'School Board': '🏫 School Board',
                'City/Town/Local': '🏘️ City/Town/Local',
                'County': '🏛️ County',
                'State Legislative': '🏛️ State Legislature',
                'State Executive': '🏛️ State Executive',
                'Federal Legislative': '🇺🇸 U.S. Congress',
                'Federal Executive': '🇺🇸 Federal Executive'
            };
            
            let html = `
                <div class="kmr-level-section">
                    <h2 class="kmr-level-title">${levelTitles[level]} (${officials.length})</h2>
                    <div class="kmr-officials-grid">
            `;
            
            officials.forEach(official => {
                const fullName = `${official.first_name || ''} ${official.last_name || ''}`.trim();
                const office = official.office || {};
                let officeName = office.name || '';
                
                // Final fallback for any remaining generic titles
                if (!officeName || officeName === 'Elected Official' || officeName === 'Office') {
                    // Try to determine based on the level we're in
                    if (level === 'State Executive') {
                        officeName = 'State Executive Official';
                    } else if (level === 'State Legislative') {
                        officeName = 'State Legislator';
                    } else if (level === 'County') {
                        officeName = 'County Official';
                    } else if (level === 'City/Town/Local') {
                        officeName = 'Local Official';
                    } else if (level === 'School Board') {
                        officeName = 'School Board Member';
                    } else if (level === 'Federal Legislative') {
                        officeName = 'Member of Congress';
                    } else if (level === 'Federal Executive') {
                        officeName = 'Federal Executive Official';
                    } else {
                        officeName = 'Elected Representative';
                    }
                }
                
                const party = official.party || '';
                
                const partyClass = party.toLowerCase().includes('democrat') ? 'party-democratic' :
                                  party.toLowerCase().includes('republican') ? 'party-republican' :
                                  party.toLowerCase().includes('nonpartisan') ? 'party-nonpartisan' :
                                  'party-independent';
                
                // Contact info
                const phone = official.phone || (official.addresses?.[0]?.phone) || '';
                const email = official.email_addresses?.[0] || '';
                const website = official.urls?.[0] || '';
                const bio = official.bio || '';
                const committees = official.committees || '';
                
                // Check if this official has enhanced data
                const isEnhanced = official.enhanced || false;
                
                html += `
                    <div class="kmr-official-card ${isEnhanced ? 'enhanced' : ''}">
                        <div class="kmr-official-name">
                            ${fullName || 'Name Not Available'}
                            ${isEnhanced ? '<span class="kmr-data-source">✓</span>' : ''}
                        </div>
                        <div class="kmr-official-office">${officeName}</div>
                        ${party ? `<span class="kmr-official-party ${partyClass}">${party}</span>` : ''}
                        
                        ${bio ? `<div class="kmr-official-bio">${bio}</div>` : ''}
                        ${committees ? `<div class="kmr-contact-item"><strong>Committees:</strong> ${committees}</div>` : ''}
                        
                        ${(phone || email || website) ? `
                            <div class="kmr-official-contact">
                                ${phone ? `<div class="kmr-contact-item"><strong>Phone:</strong> ${phone}</div>` : ''}
                                ${email ? `<div class="kmr-contact-item"><strong>Email:</strong> <a href="mailto:${email}">${email}</a></div>` : ''}
                                ${website ? `<div class="kmr-contact-item"><strong>Web:</strong> <a href="${website.startsWith('http') ? website : 'https://' + website}" target="_blank">Visit</a></div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function showAlternatives() {
            const alternativesDiv = document.getElementById('alternativesDiv');
            const address = document.getElementById('addressInput').value;
            const state = extractStateFromAddress(address);
            
            let html = `
                <div class="kmr-alternatives">
                    <h2>Find Additional Officials</h2>
                    <p style="margin-bottom: 20px;">Use these resources to find any officials not shown above:</p>
            `;
            
            // Specific resources for finding missing officials
            html += `
                <h3>Find Your U.S. House Representative</h3>
                <div class="kmr-alt-grid">
                    <a href="https://www.house.gov/representatives/find-your-representative" target="_blank" class="kmr-alt-link">
                        Official House.gov Lookup
                    </a>
                    <a href="https://ziplook.house.gov/htbin/findrep_house" target="_blank" class="kmr-alt-link">
                        Find by ZIP Code
                    </a>
                </div>
            `;
            
            // State-specific resources
            if (state === 'MD') {
                html += `
                    <h3>Maryland Specific Resources</h3>
                    <div class="kmr-alt-grid">
                        <a href="https://www.maryland.gov/pages/nearme.aspx" target="_blank" class="kmr-alt-link">
                            Maryland NearMe Portal
                        </a>
                        <a href="https://mgaleg.maryland.gov/mgawebsite/Members/District" target="_blank" class="kmr-alt-link">
                            Maryland General Assembly
                        </a>
                        <a href="https://elections.maryland.gov" target="_blank" class="kmr-alt-link">
                            Maryland Board of Elections
                        </a>
                        <a href="https://www.montgomeryschoolsmd.org/boe/" target="_blank" class="kmr-alt-link">
                            Montgomery County School Board
                        </a>
                    </div>
                `;
            } else if (state === 'VA') {
                html += `
                    <h3>Virginia Specific Resources</h3>
                    <div class="kmr-alt-grid">
                        <a href="https://whosmy.virginiageneralassembly.gov/" target="_blank" class="kmr-alt-link">
                            Virginia Who's My Legislator
                        </a>
                        <a href="https://www.virginia.gov/agencies/" target="_blank" class="kmr-alt-link">
                            Virginia Government Directory
                        </a>
                    </div>
                `;
            } else if (state === 'DC') {
                html += `
                    <h3>DC Specific Resources</h3>
                    <div class="kmr-alt-grid">
                        <a href="https://dccouncil.gov/councilmembers/" target="_blank" class="kmr-alt-link">
                            DC Council Members
                        </a>
                        <a href="https://anc.dc.gov/page/find-your-anc" target="_blank" class="kmr-alt-link">
                            Find Your ANC Commissioner
                        </a>
                    </div>
                `;
            }
            
            // National resources
            html += `
                <h3>National Databases</h3>
                <div class="kmr-alt-grid">
                    <a href="https://www.usa.gov/elected-officials" target="_blank" class="kmr-alt-link">
                        USA.gov Directory
                    </a>
                    <a href="https://ballotpedia.org/Main_Page" target="_blank" class="kmr-alt-link">
                        Ballotpedia
                    </a>
                    <a href="https://www.commoncause.org/find-your-representative/" target="_blank" class="kmr-alt-link">
                        Common Cause
                    </a>
                </div>
                
                <h3>Local Officials</h3>
                <div class="kmr-alt-grid">
                    <a href="https://www.nsba.org/state-associations" target="_blank" class="kmr-alt-link">
                        School Board Directory
                    </a>
                    <a href="https://www.sheriffs.org/sheriffs-offices" target="_blank" class="kmr-alt-link">
                        County Sheriffs
                    </a>
                    <a href="https://www.nlc.org/resources/cities-101/city-officials/" target="_blank" class="kmr-alt-link">
                        City Officials Database
                    </a>
                </div>
            </div>
            `;
            
            alternativesDiv.innerHTML = html;
        }

        function extractStateFromAddress(address) {
            const statePattern = /\b(MD|VA|DC|AL|AK|AZ|AR|CA|CO|CT|DE|FL|GA|HI|ID|IL|IN|IA|KS|KY|LA|ME|MA|MI|MN|MS|MO|MT|NE|NV|NH|NJ|NM|NY|NC|ND|OH|OK|OR|PA|RI|SC|SD|TN|TX|UT|VT|WA|WV|WI|WY)\b/i;
            const match = address.match(statePattern);
            return match ? match[1].toUpperCase() : null;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `kmr-status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showError(message) {
            const resultsDiv = document.getElementById('resultsDiv');
            resultsDiv.innerHTML = `<div class="kmr-error">${message}</div>`;
            showStatus(message, 'error');
        }

        // Initialize - add enter key support
        window.addEventListener('load', () => {
            console.log('Know My Rep loaded - Version: With Maryland Data Integration (Debugging)');
            
            // Allow Enter key to trigger search
            document.getElementById('addressInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    findRepresentatives();
                }
            });
        });
    </script>
</body>
</html>
